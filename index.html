<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Tip Pool Splitter</title>
    <style>
      :root {
        --bg: #0f172a;
        --card: #111827;
        --muted: #94a3b8;
        --text: #e5e7eb;
        --accent: #22c55e;
        --danger: #ef4444;
        --border: #1f2937;
      }
      * { box-sizing: border-box; }
      html, body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      }
      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
      }
      header {
        padding: 8px 0 16px;
      }
      h1 {
        font-size: 22px;
        margin: 0 0 8px 0;
      }
      .sub {
        color: var(--muted);
        font-size: 14px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        margin: 12px 0;
      }
      .section-title {
        font-weight: 600;
        margin: 0 0 10px 0;
        font-size: 15px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      @media (min-width: 560px) {
        .grid { grid-template-columns: repeat(3, 1fr); }
      }
      .denom {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border);
        border-radius: 10px;
      }
      .denom label { font-weight: 600; }
      .denom input {
        width: 90px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0b1220;
        color: var(--text);
        font-size: 16px;
      }
      .row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; }
      .row + .row { margin-top: 8px; }
      .row input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0b1220;
        color: var(--text);
        font-size: 16px;
      }
      .icon-btn {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0b1220;
        color: var(--text);
      }
      .actions {
        position: sticky; bottom: 0; left: 0; right: 0;
        background: linear-gradient(180deg, rgba(15,23,42,0) 0%, rgba(15,23,42,1) 20%);
        padding-top: 12px;
      }
      .btn {
        width: 100%;
        background: var(--accent);
        color: #052e16;
        border: none;
        border-radius: 10px;
        padding: 14px;
        font-weight: 700;
        font-size: 16px;
      }
      .btn.secondary {
        background: #0b1220;
        color: var(--text);
        border: 1px solid var(--border);
      }
      .muted { color: var(--muted); }
      .error { color: var(--danger); font-weight: 600; }
      .flex { display: flex; gap: 8px; }
      .justify-between { display: flex; justify-content: space-between; align-items: center; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .receipt {
        background: #0b1220;
        border: 1px dashed #374151;
        border-radius: 12px;
        padding: 14px;
      }
      .receipt h3 { margin: 0 0 8px 0; font-size: 16px; }
      .line { border-top: 1px dashed #374151; margin: 8px 0; }
      .tiny { font-size: 12px; color: var(--muted); }
      .right { text-align: right; }
      .hidden { display: none; }
      .totals-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
      .person-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: baseline; }
      .dim { color: #cbd5e1; }
      @media print {
        body { background: white; color: black; }
        .container { padding: 0; }
        .card, .receipt { background: white; border-color: #e5e7eb; }
        .actions { display: none; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Tip Pool Splitter</h1>
        <div class="sub">Split cash tips by hours worked. Mobile-friendly, printable receipt.</div>
      </header>

      <div id="inputView">
        <div class="card">
          <div class="justify-between">
            <div class="section-title">Cash tip pool</div>
            <button class="icon-btn" id="toggleDenomsBtn">Enter by bills</button>
          </div>
          <div class="denom" id="totalEntryRow" style="margin-top:10px">
            <label>Total $</label>
            <input type="number" min="0" step="1" inputmode="numeric" id="total-dollars" value="0" enterkeyhint="next" />
          </div>
          <div class="grid hidden" id="denoms">
            <div class="denom"><label>$100</label><input type="number" min="0" step="1" inputmode="numeric" enterkeyhint="next" id="denom-100" value="0" /></div>
            <div class="denom"><label>$50</label><input type="number" min="0" step="1" inputmode="numeric" enterkeyhint="next" id="denom-50" value="0" /></div>
            <div class="denom"><label>$20</label><input type="number" min="0" step="1" inputmode="numeric" enterkeyhint="next" id="denom-20" value="0" /></div>
            <div class="denom"><label>$10</label><input type="number" min="0" step="1" inputmode="numeric" enterkeyhint="next" id="denom-10" value="0" /></div>
            <div class="denom"><label>$5</label><input type="number" min="0" step="1" inputmode="numeric" enterkeyhint="next" id="denom-5" value="0" /></div>
            <div class="denom"><label>$1</label><input type="number" min="0" step="1" inputmode="numeric" enterkeyhint="done" id="denom-1" value="0" /></div>
          </div>
          <div class="totals-row mono" style="margin-top:10px">
            <div class="muted">Total tips</div>
            <div id="tipsTotalDisplay">$0.00</div>
          </div>
        </div>

        <div class="card">
          <div class="justify-between">
            <div class="section-title">Servers</div>
            <button class="icon-btn" id="addPersonBtn">＋ Add server</button>
          </div>
          <div class="tiny">Enter name and shift times (15-min steps). Overnight shifts supported.</div>
          <div id="people"></div>
        </div>

        <div class="card" id="busserCard">
          <div class="justify-between">
            <div class="section-title">Busser (optional)</div>
            <button class="icon-btn" id="addBusserBtn">＋ Add busser</button>
          </div>
          <div class="tiny">If added, busser is paid by tip-out before servers.</div>
          <div id="busserForm" class="hidden">
            <div class="row" style="margin-top:8px">
              <input type="text" placeholder="Name" class="b-name" id="b-name" autocomplete="name" autocapitalize="words" enterkeyhint="next" />
              <input type="time" class="b-start" id="b-start" step="900" enterkeyhint="next" />
              <input type="time" class="b-end" id="b-end" step="900" enterkeyhint="done" />
              <button class="icon-btn" id="removeBusserBtn" title="Remove">✕</button>
            </div>
            <div class="grid" style="margin-top:10px">
              <div class="denom"><label>TipOut %</label><input type="number" min="0" step="1" inputmode="numeric" id="busser-tipout" value="10" /></div>
              <div class="denom"><label>Tip Hours</label><input type="number" min="0" step="0.25" inputmode="decimal" id="busser-tiphours" value="0" /></div>
            </div>
          </div>
        </div>

        <div class="actions">
          <div class="flex">
            <button class="btn" id="calcBtn">Calculate tips</button>
            <button class="btn secondary" id="resetBtn">Reset</button>
          </div>
          <div class="tiny error" id="errorBox" style="margin-top:8px; display:none;"></div>
        </div>
      </div>

      <div id="resultView" class="hidden">
        <div class="card receipt">
          <div class="justify-between">
            <h3>Tip Pool Receipt</h3>
            <div class="tiny" id="dateDisplay"></div>
          </div>
          <div class="line"></div>
          <div class="totals-row mono">
            <div>Total tips</div>
            <div id="r-totalTips">$0.00</div>
          </div>
          <div class="totals-row mono">
            <div>Total hours</div>
            <div id="r-totalHours">0.00 h</div>
          </div>
          <div class="totals-row mono">
            <div>Tips per hour</div>
            <div id="r-rate">$0.00/hr</div>
          </div>
          <div class="line"></div>
          <div id="r-people"></div>
          <div class="line"></div>
          <div class="totals-row mono">
            <div class="dim">Sum of payouts</div>
            <div id="r-sumPayouts">$0.00</div>
          </div>
          <div class="totals-row mono">
            <div class="dim">Remainder</div>
            <div id="r-remainder">$0.00</div>
          </div>
        </div>
        <div class="actions">
          <div class="flex">
            <button class="btn" id="saveBtn">Save receipt to Photos</button>
            <button class="btn secondary" id="editBtn">Edit inputs</button>
          </div>
        </div>
      </div>
    </div>

    <template id="person-row-template">
      <div class="row person-input">
        <input type="text" placeholder="Name" class="p-name" autocomplete="name" autocapitalize="words" enterkeyhint="next" />
        <input type="time" class="p-start" step="900" enterkeyhint="next" />
        <input type="time" class="p-end" step="900" enterkeyhint="done" />
        <button class="icon-btn remove-btn" title="Remove">✕</button>
      </div>
    </template>

    <script>
      const DOM = {
        inputView: document.getElementById('inputView'),
        resultView: document.getElementById('resultView'),
        tipsTotalDisplay: document.getElementById('tipsTotalDisplay'),
        errorBox: document.getElementById('errorBox'),
        people: document.getElementById('people'),
        addPersonBtn: document.getElementById('addPersonBtn'),
        calcBtn: document.getElementById('calcBtn'),
        resetBtn: document.getElementById('resetBtn'),
        saveBtn: document.getElementById('saveBtn'),
        editBtn: document.getElementById('editBtn'),
        dateDisplay: document.getElementById('dateDisplay'),
        rTotalTips: document.getElementById('r-totalTips'),
        rTotalHours: document.getElementById('r-totalHours'),
        rRate: document.getElementById('r-rate'),
        rPeople: document.getElementById('r-people'),
        rSumPayouts: document.getElementById('r-sumPayouts'),
        rRemainder: document.getElementById('r-remainder'),
        toggleDenomsBtn: document.getElementById('toggleDenomsBtn'),
        totalDollars: document.getElementById('total-dollars'),
        denomsContainer: document.getElementById('denoms'),
        // Busser
        busserCard: document.getElementById('busserCard'),
        addBusserBtn: document.getElementById('addBusserBtn'),
        removeBusserBtn: document.getElementById('removeBusserBtn'),
        busserForm: document.getElementById('busserForm'),
        bName: document.getElementById('b-name'),
        bStart: document.getElementById('b-start'),
        bEnd: document.getElementById('b-end'),
        bTipOut: document.getElementById('busser-tipout'),
        bTipHours: document.getElementById('busser-tiphours'),
      };

      const DENOMS = [
        { id: 'denom-100', cents: 10000, label: '$100' },
        { id: 'denom-50', cents: 5000, label: '$50' },
        { id: 'denom-20', cents: 2000, label: '$20' },
        { id: 'denom-10', cents: 1000, label: '$10' },
        { id: 'denom-5', cents: 500, label: '$5' },
        { id: 'denom-1', cents: 100, label: '$1' },
      ];

      let entryMode = 'total'; // 'total' | 'denoms'
      let defaultStartTime = '';
      let defaultEndTime = '';

      function formatCurrency(cents) {
        const isNegative = cents < 0;
        const abs = Math.abs(Math.round(cents));
        const dollars = Math.floor(abs / 100);
        const rem = String(abs % 100).padStart(2, '0');
        return (isNegative ? '-' : '') + '$' + dollars.toLocaleString() + '.' + rem;
      }

      function parseIntOrZero(value) {
        const n = parseInt(value, 10);
        return Number.isFinite(n) && n > 0 ? n : 0;
      }

      function getTotalTipsCents() {
        if (entryMode === 'denoms') {
          let total = 0;
          for (const d of DENOMS) {
            const el = document.getElementById(d.id);
            const qty = parseIntOrZero(el.value);
            total += qty * d.cents;
          }
          return total;
        }
        const dollars = parseIntOrZero(DOM.totalDollars.value);
        return dollars * 100;
      }

      function gatherDenoms() {
        const items = [];
        let sum = 0;
        if (entryMode === 'denoms') {
          for (const d of DENOMS) {
            const el = document.getElementById(d.id);
            const qty = parseIntOrZero(el.value);
            if (qty > 0) {
              const amount = qty * d.cents;
              sum += amount;
              items.push({ label: d.label, qty, amountCents: amount });
            }
          }
        }
        return { items, totalCents: sum };
      }

      function hhmmToMinutes(hhmm) {
        if (!hhmm || !/^[0-9]{2}:[0-9]{2}$/.test(hhmm)) return null;
        const [h, m] = hhmm.split(':').map(Number);
        if (h > 23 || m > 59) return null;
        return h * 60 + m;
      }

      function computeHours(startStr, endStr) {
        const start = hhmmToMinutes(startStr);
        const end = hhmmToMinutes(endStr);
        if (start == null || end == null) return null;
        let delta = end - start;
        if (delta < 0) delta += 24 * 60; // overnight shift
        return delta / 60;
      }

      function showError(msg) {
        DOM.errorBox.style.display = 'block';
        DOM.errorBox.textContent = msg;
      }
      function clearError() {
        DOM.errorBox.style.display = 'none';
        DOM.errorBox.textContent = '';
      }

      function addPersonRow(defaults = {}) {
        const tpl = document.getElementById('person-row-template');
        const node = tpl.content.firstElementChild.cloneNode(true);
        const name = node.querySelector('.p-name');
        const start = node.querySelector('.p-start');
        const end = node.querySelector('.p-end');
        const remove = node.querySelector('.remove-btn');
        if (defaults.name) name.value = defaults.name;
        if (defaults.start) start.value = defaults.start;
        if (defaults.end) end.value = defaults.end;
        // Apply default times if available
        if (!start.value && defaultStartTime) start.value = defaultStartTime;
        if (!end.value && defaultEndTime) end.value = defaultEndTime;
        remove.addEventListener('click', () => node.remove());
        name.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); start.focus(); }});
        start.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); end.focus(); }});
        end.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const rows = Array.from(DOM.people.querySelectorAll('.person-input'));
            const idx = rows.indexOf(node);
            const nextRow = rows[idx + 1];
            if (nextRow) {
              const nextName = nextRow.querySelector('.p-name');
              if (nextName) nextName.focus();
            } else {
              DOM.addPersonBtn.focus();
            }
          }
        });
        DOM.people.appendChild(node);
        // When first non-empty times are set anywhere, capture as defaults and fill blank rows
        const onTimeChange = () => {
          const s = start.value.trim();
          const e = end.value.trim();
          if (!defaultStartTime && s) defaultStartTime = s;
          if (!defaultEndTime && e) defaultEndTime = e;
          if ((s || e) && (defaultStartTime || defaultEndTime)) {
            const rows = Array.from(DOM.people.querySelectorAll('.person-input'));
            for (const r of rows) {
              const rs = r.querySelector('.p-start');
              const re = r.querySelector('.p-end');
              if (!rs.value && defaultStartTime) rs.value = defaultStartTime;
              if (!re.value && defaultEndTime) re.value = defaultEndTime;
            }
          }
        };
        start.addEventListener('change', onTimeChange);
        end.addEventListener('change', onTimeChange);
      }

      function gatherPeople() {
        const rows = Array.from(DOM.people.querySelectorAll('.person-input'));
        const people = [];
        for (const row of rows) {
          const name = row.querySelector('.p-name').value.trim();
          const start = row.querySelector('.p-start').value.trim();
          const end = row.querySelector('.p-end').value.trim();
          if (!name && !start && !end) continue; // ignore blank row
          const hours = computeHours(start, end);
          if (!name || hours == null) {
            throw new Error('Please provide a name and valid start/end times for each person.');
          }
          people.push({ name, start, end, hours });
        }
        return people;
      }

      function calculate() {
        clearError();
        const totalTips = getTotalTipsCents();
        if (totalTips <= 0) {
          showError('Enter a positive cash tip total.');
          return;
        }
        let people;
        try {
          people = gatherPeople();
        } catch (e) {
          showError(e.message);
          return;
        }
        if (people.length === 0) {
          showError('Add at least one person with valid times.');
          return;
        }
        const totalHours = people.reduce((s, p) => s + p.hours, 0);
        if (totalHours <= 0) {
          showError('Total hours must be greater than zero.');
          return;
        }

        // Optional busser logic
        let busser = null;
        let servers = people;
        let serversTipsTotal = totalTips;
        if (!DOM.busserForm.classList.contains('hidden')) {
          const bname = DOM.bName.value.trim();
          const bs = DOM.bStart.value.trim();
          const be = DOM.bEnd.value.trim();
          if (bname || bs || be) {
            const bhours = computeHours(bs, be);
            if (!bname || bhours == null) {
              showError('Provide busser name and valid start/end times or remove busser.');
              return;
            }
            const maxServerHours = Math.max(...people.map(p => p.hours));
            const tipHoursInput = parseFloat(String(DOM.bTipHours.value).replace(/,/g, ''));
            const tipHours = Number.isFinite(tipHoursInput) && tipHoursInput > 0 ? tipHoursInput : maxServerHours;
            const tipOutPct = Math.max(0, parseInt(String(DOM.bTipOut.value), 10) || 0);
            const busserRaw = (tipOutPct / 100) * (bhours / tipHours) * totalTips; // cents float
            const busserPay = Math.floor(busserRaw / 100) * 100; // floor to dollars
            busser = { name: bname, hours: bhours, payoutCents: busserPay, rawShareCents: busserRaw };
            serversTipsTotal = Math.max(0, Math.round(totalTips - busserPay));
          }
        }

        const rateCentsPerHour = serversTipsTotal / totalHours; // floating
        const rateDisplay = '$' + (rateCentsPerHour / 100).toFixed(2) + '/hr';

        // Per-person payout for servers: proportional share, rounded down to nearest dollar
        let sumPayouts = busser ? busser.payoutCents : 0;
        const detailed = people.map(p => {
          const rawShareCents = rateCentsPerHour * p.hours; // floating cents
          const flooredToDollar = Math.floor(rawShareCents / 100) * 100; // integer cents
          sumPayouts += flooredToDollar;
          return {
            name: p.name,
            hours: p.hours,
            payoutCents: flooredToDollar,
            rawShareCents,
          };
        });
        const remainder = Math.round(totalTips - sumPayouts);

        const breakdown = gatherDenoms();
        // Optional bill distribution (only if denoms entered)
        let billPlan = null;
        if (breakdown.items && breakdown.items.length > 0) {
          billPlan = computeBillPlan({ people: detailed, busser, denoms: breakdown });
        }

        renderReceipt({
          totalTips,
          totalHours,
          rateDisplay,
          people: detailed,
          sumPayouts,
          remainder,
          breakdown,
          busser,
          billPlan,
        });
      }

      function renderReceipt(model) {
        DOM.inputView.classList.add('hidden');
        DOM.resultView.classList.remove('hidden');
        DOM.dateDisplay.textContent = new Date().toLocaleString();
        DOM.rTotalTips.textContent = formatCurrency(model.totalTips);
        DOM.rTotalHours.textContent = model.totalHours.toFixed(2) + ' h';
        DOM.rRate.textContent = model.rateDisplay;
        DOM.rSumPayouts.textContent = formatCurrency(model.sumPayouts);
        DOM.rRemainder.textContent = formatCurrency(model.remainder);

        DOM.rPeople.innerHTML = '';
        // Optional busser display
        if (model.busser) {
          const row = document.createElement('div');
          row.className = 'person-row mono';
          const left = document.createElement('div');
          const right = document.createElement('div');
          right.className = 'right';
          const hoursStr = model.busser.hours.toFixed(2);
          left.innerHTML = `<strong>${escapeHtml(model.busser.name)} (Busser)</strong><div class="tiny">${hoursStr} h via tip-out</div>`;
          right.innerHTML = `<div>${formatCurrency(model.busser.payoutCents)}</div>`;
          row.appendChild(left);
          row.appendChild(right);
          DOM.rPeople.appendChild(row);
          const line = document.createElement('div');
          line.className = 'line';
          DOM.rPeople.appendChild(line);
        }
        // Cash breakdown
        let breakdownHost = document.getElementById('r-breakdown');
        if (!breakdownHost) {
          const receiptCard = document.querySelector('#resultView .receipt');
          const line = document.createElement('div');
          line.className = 'line';
          breakdownHost = document.createElement('div');
          breakdownHost.id = 'r-breakdown';
          breakdownHost.className = 'mono';
          const insertBefore = document.getElementById('r-people');
          receiptCard.insertBefore(line, insertBefore);
          receiptCard.insertBefore(breakdownHost, insertBefore);
        }
        if (model.breakdown && model.breakdown.items && model.breakdown.items.length > 0) {
          const parts = [];
          parts.push('<div class="tiny">Cash breakdown</div>');
          for (const item of model.breakdown.items) {
            const right = formatCurrency(item.amountCents);
            parts.push(`<div class="totals-row"><div class="mono">${item.label} × ${item.qty}</div><div class="mono right">${right}</div></div>`);
          }
          parts.push('<div class="line"></div>');
          parts.push(`<div class="totals-row mono"><div class="dim">Sum of bills</div><div>${formatCurrency(model.breakdown.totalCents)}</div></div>`);
          breakdownHost.innerHTML = parts.join('');
        } else {
          breakdownHost.innerHTML = `<div class="tiny">Cash total entered: ${formatCurrency(model.totalTips)}</div>`;
        }
        for (const p of model.people) {
          const row = document.createElement('div');
          row.className = 'person-row mono';
          const left = document.createElement('div');
          const right = document.createElement('div');
          right.className = 'right';
          const hoursStr = p.hours.toFixed(2);
          left.innerHTML = `<strong>${escapeHtml(p.name)}</strong><div class="tiny">${hoursStr} h × ${model.rateDisplay}</div>`;
          right.innerHTML = `<div>${formatCurrency(p.payoutCents)}</div>`;
          row.appendChild(left);
          row.appendChild(right);
          DOM.rPeople.appendChild(row);
          if (model.billPlan && model.billPlan.perPerson && model.billPlan.perPerson[p.name]) {
            const summary = document.createElement('div');
            summary.className = 'tiny';
            const bills = model.billPlan.perPerson[p.name];
            const parts = [];
            const order = [10000,5000,2000,1000,500,100];
            for (const v of order) {
              const n = bills[v] || 0;
              if (n > 0) parts.push(`$${v/100}×${n}`);
            }
            if (parts.length) {
              summary.textContent = 'Bills: ' + parts.join(', ');
              DOM.rPeople.appendChild(summary);
            }
          }
        }

        // Suggested exchanges
        if (model.billPlan && model.billPlan.exchanges && model.billPlan.exchanges.length) {
          const line = document.createElement('div');
          line.className = 'line';
          DOM.rPeople.appendChild(line);
          const exTitle = document.createElement('div');
          exTitle.className = 'tiny';
          exTitle.textContent = 'Suggested exchanges to improve bill balance';
          DOM.rPeople.appendChild(exTitle);
          for (const ex of model.billPlan.exchanges) {
            const row = document.createElement('div');
            row.className = 'totals-row mono';
            row.innerHTML = `<div>Exchange ${ex.fromQty}×$${ex.from/100}</div><div class="right">for ${ex.to.map(x=>x.qty+`×$${x.value/100}`).join(' + ')}</div>`;
            DOM.rPeople.appendChild(row);
          }
        }
      }

      // Bills planning
      function computeBillPlan({ people, busser, denoms }) {
        const counts = { 10000:0, 5000:0, 2000:0, 1000:0, 500:0, 100:0 };
        for (const item of denoms.items) {
          const label = item.label.replace('$','');
          const value = parseInt(label, 10) * 100;
          if (counts[value] != null) counts[value] += item.qty;
        }
        const valuesDesc = [10000, 5000, 2000, 1000, 500, 100];
        const totalAmount = Object.entries(counts).reduce((s,[v,c])=>s + (+v)*c, 0);
        const totalBills = Object.values(counts).reduce((s,c)=>s+c,0);
        if (totalAmount === 0 || totalBills === 0) return null;
        const avgBill = totalAmount / totalBills;

        const perPerson = {};
        const remaining = { ...counts };
        const exchanges = [];

        function makeChangeGreedy(amount) {
          const used = { 10000:0,5000:0,2000:0,1000:0,500:0,100:0 };
          let rem = amount;
          for (const v of valuesDesc) {
            if (rem <= 0) break;
            const maxNeed = Math.floor(rem / v);
            const take = Math.min(maxNeed, remaining[v]);
            if (take > 0) {
              used[v] += take;
              remaining[v] -= take;
              rem -= take * v;
            }
          }
          return rem === 0 ? used : null;
        }

        function tryIncreaseBillCount(used, targetBills) {
          const currentBills = Object.values(used).reduce((s,c)=>s+c,0);
          if (currentBills >= targetBills) return;
          let need = targetBills - currentBills;
          // Break larger bills into smaller ones if possible
          const breakMap = { 10000:[5000,5000], 5000:[1000,1000,1000,1000,1000], 2000:[1000,1000], 1000:[500,500], 500:[100,100,100,100,100] };
          for (const v of valuesDesc) {
            while (need > 0 && used[v] > 0) {
              const to = breakMap[v];
              if (!to) break;
              // Check availability of smaller bills
              const can = to.every(x => remaining[x] > 0);
              if (!can) break;
              // Perform exchange: put back one v, take "to"
              used[v] -= 1;
              remaining[v] += 1;
              for (const x of to) { remaining[x] -= 1; used[x] += 1; }
              exchanges.push({ from: v, fromQty: 1, to: aggregateToList(to) });
              need -= (to.length - 1); // net bill count increase
            }
            if (need <= 0) break;
          }
        }

        function aggregateToList(arr) {
          const m = {};
          for (const v of arr) m[v] = (m[v]||0) + 1;
          return Object.entries(m).map(([value, qty]) => ({ value: +value, qty }));
        }

        for (const p of people) {
          const targetBills = Math.max(1, Math.round(p.payoutCents / avgBill));
          let used = makeChangeGreedy(p.payoutCents);
          if (!used) {
            // Not enough small bills; cannot make exact change with current pool.
            // Fallback: attempt to create ones by exchanging the smallest larger bills available.
            // Try progressively breaking bills until we can make change.
            const needed = p.payoutCents;
            let attempts = 0;
            while (!used && attempts < 20) {
              const source = valuesDesc.find(v => remaining[v] > 0 && v > 100);
              if (!source) break;
              // Prefer breaking to maximize smalls without going larger
              let to;
              if (source === 1000 && remaining[500] >= 2) to = [500,500];
              else if (source === 2000 && remaining[1000] >= 1) to = [1000,1000];
              else if (source === 5000 && (remaining[1000] >= 5)) to = [1000,1000,1000,1000,1000];
              else if (source === 10000 && remaining[5000] >= 2) to = [5000,5000];
              else if (source === 5000 && remaining[500] >= 10) to = Array(10).fill(500);
              else if (source === 1000 && remaining[100] >= 10) to = Array(10).fill(100);
              else if (source === 2000 && remaining[500] >= 4) to = Array(4).fill(500);
              else if (source === 10000 && remaining[1000] >= 10) to = Array(10).fill(1000);
              else if (source === 2000 && remaining[100] >= 20) to = Array(20).fill(100);
              else if (source === 5000 && remaining[100] >= 50) to = Array(50).fill(100);
              else if (source === 10000 && remaining[100] >= 100) to = Array(100).fill(100);
              else break;
              remaining[source] -= 1;
              for (const x of to) remaining[x] -= 0; // no-op to satisfy lints
              exchanges.push({ from: source, fromQty: 1, to: aggregateToList(to) });
              // Actually add the smaller bills to remaining
              for (const x of to) remaining[x] = (remaining[x] || 0) + 1;
              attempts++;
              used = makeChangeGreedy(needed);
            }
          }
          if (!used) return { perPerson: perPerson, exchanges };
          tryIncreaseBillCount(used, targetBills);
          perPerson[p.name] = used;
        }
        return { perPerson, exchanges };
      }

      function escapeHtml(s) {
        return s.replace(/[&<>"]+/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
      }

      function updateTipsTotalDisplay() {
        DOM.tipsTotalDisplay.textContent = formatCurrency(getTotalTipsCents());
      }

      function setEntryMode(mode) {
        entryMode = mode;
        if (entryMode === 'denoms') {
          DOM.denomsContainer.classList.remove('hidden');
          document.getElementById('totalEntryRow').classList.add('hidden');
          DOM.toggleDenomsBtn.textContent = 'Enter total only';
        } else {
          DOM.denomsContainer.classList.add('hidden');
          document.getElementById('totalEntryRow').classList.remove('hidden');
          DOM.toggleDenomsBtn.textContent = 'Enter by bills';
        }
        updateTipsTotalDisplay();
      }

      function resetAll() {
        // Reset denoms
        for (const d of DENOMS) {
          const el = document.getElementById(d.id);
          el.value = '0';
        }
        DOM.totalDollars.value = '0';
        setEntryMode('total');
        updateTipsTotalDisplay();
        // Reset people
        DOM.people.innerHTML = '';
        addPersonRow();
        addPersonRow();
        addPersonRow();
        const firstName = DOM.people.querySelector('.person-input .p-name');
        if (firstName) firstName.focus();
        clearError();
        // Reset busser
        DOM.busserForm.classList.add('hidden');
        DOM.addBusserBtn.classList.remove('hidden');
        DOM.bName.value = '';
        DOM.bStart.value = '';
        DOM.bEnd.value = '';
        DOM.bTipOut.value = '10';
        DOM.bTipHours.value = '0';
        defaultStartTime = '';
        defaultEndTime = '';
        // Views
        DOM.resultView.classList.add('hidden');
        DOM.inputView.classList.remove('hidden');
      }

      // Wire up
      function attachNumericInputBehavior(el) {
        el.addEventListener('focus', () => {
          if (el.value === '0' || el.value === '0.00') {
            el.value = '';
          } else {
            el.select();
          }
        });
        el.addEventListener('blur', () => {
          if (el.value === '') el.value = '0';
        });
      }

      DENOMS.forEach(d => {
        const el = document.getElementById(d.id);
        el.addEventListener('input', updateTipsTotalDisplay);
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const ids = DENOMS.map(x => x.id);
            const idx = ids.indexOf(d.id);
            if (idx >= 0 && idx < ids.length - 1) {
              document.getElementById(ids[idx + 1]).focus();
            } else {
              DOM.calcBtn.focus();
            }
          }
        });
        attachNumericInputBehavior(el);
      });
      DOM.addPersonBtn.addEventListener('click', () => {
        addPersonRow();
        const inputs = DOM.people.querySelectorAll('.person-input .p-name');
        if (inputs.length) inputs[inputs.length - 1].focus();
      });
      DOM.calcBtn.addEventListener('click', calculate);
      DOM.resetBtn.addEventListener('click', resetAll);
      DOM.editBtn.addEventListener('click', () => {
        DOM.resultView.classList.add('hidden');
        DOM.inputView.classList.remove('hidden');
      });
      // Save receipt image
      DOM.saveBtn.addEventListener('click', async () => {
        const card = document.querySelector('#resultView .receipt');
        try {
          if (window.html2canvas) {
            const canvas = await window.html2canvas(card, { scale: 2, backgroundColor: getComputedStyle(card).backgroundColor });
            canvas.toBlob((blob) => {
              if (!blob) return;
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              const ts = new Date();
              const fname = `tip-pool-${ts.getFullYear()}-${String(ts.getMonth()+1).padStart(2,'0')}-${String(ts.getDate()).padStart(2,'0')}.png`;
              a.href = url;
              a.download = fname;
              document.body.appendChild(a);
              a.click();
              a.remove();
              setTimeout(() => URL.revokeObjectURL(url), 5000);
            });
          } else {
            window.print();
          }
        } catch (e) {
          window.print();
        }
      });
      DOM.toggleDenomsBtn.addEventListener('click', () => {
        setEntryMode(entryMode === 'denoms' ? 'total' : 'denoms');
      });
      DOM.totalDollars.addEventListener('input', updateTipsTotalDisplay);
      attachNumericInputBehavior(DOM.totalDollars);

      // Busser UI
      DOM.addBusserBtn.addEventListener('click', () => {
        DOM.busserForm.classList.remove('hidden');
        DOM.addBusserBtn.classList.add('hidden');
        // Default Tip Hours to max server hours
        try {
          const ppl = gatherPeople();
          const maxServerHours = ppl.length ? Math.max(...ppl.map(p => p.hours)) : 0;
          DOM.bTipHours.value = String(maxServerHours.toFixed(2));
        } catch {}
      });
      DOM.removeBusserBtn.addEventListener('click', () => {
        DOM.busserForm.classList.add('hidden');
        DOM.addBusserBtn.classList.remove('hidden');
        DOM.bName.value = '';
        DOM.bStart.value = '';
        DOM.bEnd.value = '';
      });

      // Init
      resetAll();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  </body>
</html>

